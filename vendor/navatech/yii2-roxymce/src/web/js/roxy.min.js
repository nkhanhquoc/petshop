/**
 * Created by phuon on 11/4/2016.
 */
function showFileList(e){var t="";$(".file-list-item").html(""),$("#txtSearch").val(""),current_url=e,$.ajax({type:"GET",cache:!1,dataType:"json",url:e,success:function(e){if(0===e.error){$.each(e.content,function(e,a){$("button[data-name='thumb_view']").hasClass("btn-primary")?(t+='<div class="item"><div class="col-sm-3">',t+='<div class="thumb" data-url="'+a.url+'" data-title="'+a.name+'" data-image='+a.is_image+">",t+='<div class="file-preview"><img class="lazy" data-original="'+a.preview+'"></div>',t+='<div class="file-name"><span>'+a.name+"</span></div>",t+='<div class="file-size">'+a.size+"</div>",t+="</div>",t+="</div>",t+="</div>",$(".sort-actions").hide()):(t+='<div class="item"><div class="row list" data-url="'+a.url+'" data-title="'+a.name+'" data-image='+a.is_image+">",t+='<div class="col-sm-7 file-name"><img class="icon" src="'+a.icon+'"><span>'+a.name+"</span></div>",t+='<div class="col-sm-2 file-size">'+a.size+"</div>",t+='<div class="col-sm-3 file-date">'+a.date+"</div>",t+="</div>",t+="</div>",$(".sort-actions").show())}),""===t&&(t=msg_empty_directory);var a=$(".file-list-item");a.html(t),$("img.lazy").lazyload({container:a,effect:"fadeIn"})}else alert(e.message),$(".file-list-item").html(msg_empty_directory)},error:function(){alert(msg_somethings_went_wrong),$(".file-list-item").html(msg_empty_directory)}})}function showFolderList(e){return $.ajax({type:"GET",cache:!1,dataType:"json",url:e,success:function(e){if(0===e.error){folder_list.treeview({data:e.content,preventUnselect:!0});var t=folder_list.treeview("getNodes",node_id),a=$("#folder-rename");a.find("input[name='folder']").val(t.path),a.find("input#folder_name").val(t.text)}else alert(e.message)},error:function(){alert(msg_somethings_went_wrong)}}),folder_list}function getUrlParam(e,t){var a="";if(t||(t=self.location.href),t.indexOf("?")>-1){t=(t=t.substr(t.indexOf("?")+1)).split("&");for(var r=0;r<t.length;r++){var i=t[r].split("=");if(i[0]&&i[1]&&i[0]===e){a=i[1];break}}}return a}function parseQuery(e){for(var t=e.split("&"),a=[],r=0;r<t.length;r++){var i=t[r].split("="),l=decodeURIComponent(i[0]);l.indexOf("?")>=0&&(l=l.split("?")[1]);var n=decodeURIComponent(i[1]);a.push({name:l,value:n})}return a}function progress(e){if(e.lengthComputable){var t=e.total,a=e.loaded,r=Math.round(100*a/t);$(".progress-bar").css({width:r+"%"}).html(r+"%"),r>=100&&setTimeout(function(){$(".progress").fadeOut("normal",function(){$(".progress-bar").css({width:"0%"}).html("0%")})},1e3)}}function reloadTreeview(e){node_id=e.nodeId,$("#folder-rename").find("input[name='folder']").val(e.path).parent().find("input[name='name']").val(e.text),$("#folder-create").find("input[name='folder']").val(e.path),$("#uploadform-file").attr("data-url",url_file_upload+"?folder="+e.path).attr("data-href",e.href),$("#txtSearch").val(""),reloadActionButton()}function reloadActionButton(){$(".first-row button,.first-row a").attr("disabled","disabled");var e=$(".btn-file-preview");e.removeAttr("href").attr("title",e.text());var t=$(".btn-file-download");t.removeAttr("href").attr("title",t.text()),$(".btn-roxymce-select").attr("disabled","disabled")}function closeDialog(e){switch(e){case"fancybox":parent.$.fancybox.close(),$.fancybox.close();break;case"modal":var t=parent.$(".modal-roxy").attr("id");parent.$("#"+t).modal("hide")}}var node_id=0,folder_list=$(".folder-list"),current_url="",file_cut,file_copy,target=null;$(function(){showFolderList(folder_list.data("url")),showFileList($(".file-list").data("url")),$("a#single_image").fancybox()}),$(document).on("submit","form",function(e){return e.preventDefault(),!1}),$(document).on("nodeSelected",".folder-list",function(e,t){reloadTreeview(t),showFileList(t.href)}),$(document).on("click","[data-action='switch_view']",function(){$("[data-action='switch_view']").removeClass("btn-primary"),$(this).addClass("btn-primary"),$(".file-body").removeClass("thumb_view list_view").addClass($(this).data("name")),$(".first-row button,.first-row a").attr("disabled","disabled"),$(".btn-file-preview").removeAttr("href"),$(".btn-roxymce-select").attr("disabled","disabled"),$("#txtSearch").val(""),showFileList(current_url)}),$(document).on("click",".file-list-item .thumb,.file-list-item .list",function(){var e=$(this);$(".file-list-item .thumb, .file-list-item .list").removeClass("selected"),e.addClass("selected"),$(".first-row button,.first-row a").removeAttr("disabled"),$(".btn-file-download").attr("href",e.data("url")).attr("target","_blank"),$(".btn-file-preview").attr("href",e.data("url")).attr("title",e.data("title")).fancybox({type:1===e.data("image")?"image":"iframe",padding:5,fitToView:!0,autoSize:!0});var t=folder_list.treeview("getSelected"),a=$("#file-rename");a.find("input[name='file']").val(e.data("title")),a.find("input[name='name']").val(e.data("title")),a.find("input[name='folder']").val(t[0].path),$(".btn-roxymce-select").removeAttr("disabled")}),$(document).on("click","#folder-create .btn-submit",function(){var e=folder_list.treeview("getSelected");if(0!==e.length){var t=$(this).closest(".modal").find("form");$.ajax({type:"GET",cache:!1,data:t.serializeArray(),url:t.attr("action"),dataType:"json",success:function(t){if(0===t.error){var a=$("#folder-create");a.modal("hide"),a.find("input[name='name']").val("");var r={text:t.data.text,href:t.data.href,path:t.data.path,icon:"glyphicon glyphicon-folder-close",selectedIcon:"glyphicon glyphicon-folder-open"};folder_list.treeview("addNode",[r,e])}else alert(t.message)},error:function(){alert(msg_somethings_went_wrong)}})}else alert(msg_please_select_one_folder),$("#folder-create").modal("hide");return!1}),$(document).on("click","#folder-rename .btn-submit",function(){var e=folder_list.treeview("getSelected");if(0!==e.length){var t=$(this).closest(".modal").find("form");$.ajax({type:"GET",cache:!1,data:t.serializeArray(),url:t.attr("action"),dataType:"json",success:function(t){if(0===t.error){$("#folder-rename").modal("hide");var a={text:t.data.text,href:t.data.href,path:t.data.path,icon:"glyphicon glyphicon-folder-close",selectedIcon:"glyphicon glyphicon-folder-open"};folder_list.treeview("updateNode",[e,a]).treeview("selectNode",[a,{silent:!0}]),reloadTreeview(a)}else alert(t.message)},error:function(){alert(msg_somethings_went_wrong)}})}else alert(msg_please_select_one_folder),$("#folder-rename").modal("hide");return!1}),$(document).on("click","#file-rename .btn-submit",function(){var e=$(this).closest(".modal").find("form");return $.ajax({type:"GET",cache:!1,data:e.serializeArray(),url:e.attr("action"),dataType:"json",success:function(e){if(0===e.error){var t=$("#file-rename");t.find("input[name='file']").val(e.data.name),t.modal("hide"),$(".file-list-item").find(".selected").find(".file-name").find("span").text(e.data.name)}else alert(e.message)},error:function(){alert(msg_somethings_went_wrong)}}),!1}),$(document).on("click",".btn-folder-remove",function(){var e=folder_list.treeview("getSelected"),t=folder_list.treeview("getParents",e)[0];confirm(msg_are_you_sure)&&$.ajax({type:"GET",cache:!1,url:url_folder_remove+"?folder="+e[0].path,dataType:"json",success:function(a){0===a.error?(folder_list.treeview("removeNode",[e,{silent:!0}]).treeview("selectNode",[t,{silent:!0}]),current_url=t.href,reloadTreeview(t),showFileList(current_url)):alert(a.message)},error:function(){alert(msg_somethings_went_wrong)}})}),$(document).on("click",".btn-file-remove",function(){var e=confirm(msg_are_you_sure),t=folder_list.treeview("getSelected"),a=$(".btn-file-preview").attr("title");e&&$.ajax({type:"GET",cache:!1,url:url_file_remove+"?folder="+t[0].path+"&file="+a,dataType:"json",success:function(e){if(0===e.error){var t=$(".file-list-item").find(".selected");t.hasClass("list")?t.fadeOut("normal",function(){$(this).remove()}):t.parent().fadeOut("normal",function(){$(this).remove()})}else alert(e.message);reloadActionButton()},error:function(){alert(msg_somethings_went_wrong),reloadActionButton()}})}),$(document).on("change","input#uploadform-file",function(){$(".progress").show();var e=$(this),t=e.prop("files"),a=new FormData;$.each(t,function(e,t){a.append("UploadForm[file][]",t)}),$.ajax({type:"POST",url:e.attr("data-url"),cache:!1,data:a,xhr:function(){var e=$.ajaxSettings.xhr();return e.upload&&e.upload.addEventListener("progress",progress,!1),e},dataType:"json",processData:!1,contentType:!1,success:function(t){0===t.error?($(".image-list").append(t.html),showFileList(e.attr("data-href"))):alert(t.message)},error:function(){alert(msg_somethings_went_wrong)}})}),$(document).on("click",".btn-roxymce-close",function(){var e=window.opener?window.opener:window.parent;e.tinyMCE&&e.tinyMCE.activeEditor.windowManager.close(),closeDialog(getUrlParam("dialog"))}),$(document).on("click",".btn-roxymce-select",function(){var e=window.opener?window.opener:window.parent,t=$(".file-list-item").find(".selected");e.document.getElementById(getUrlParam("input")).value=t.attr("data-url"),void 0!==e.ImageDialog&&(e.ImageDialog.getImageData&&e.ImageDialog.getImageData(),e.ImageDialog.showPreviewImage()&&e.ImageDialog.showPreviewImage(t.attr("data-url"))),e.tinyMCE&&e.tinyMCE.activeEditor.windowManager.close(),closeDialog(getUrlParam("dialog"))}),$(document).on("keyup","#txtSearch",function(){var e=$(this).val(),t=$(".file-list-item .item");t.show(),$.each(t,function(t,a){var r=$(a).find(".file-name span").text();if(r.indexOf(e)<0)$(a).hide();else{var i=new RegExp(e,"g");r=r.replace(i,'<b class="highlight">'+e+"</b>"),$(a).find(".file-name span").html(r)}})}),$(document).on("click",'[rel="order"]',function(){$('[rel="order"]').removeClass("sorted");var e=$(this).attr("data-order"),t=2,a=!1,r=folder_list.treeview("getSelected");switch("desc"===$(this).attr("data-sort")?($(this).addClass("sorted").attr("data-sort","asc"),e+="_asc"):($(this).addClass("sorted").attr("data-sort","desc"),e+="_desc"),e){case"date_asc":t=1;break;case"date_desc":t=2;break;case"name_asc":t=3;break;case"name_desc":t=4;break;case"size_asc":t=5;break;case"size_desc":t=6;break;default:t=2}var i=r[0].href;$.each(parseQuery(i),function(e,t){"sort"===e&&(a=e+"="+t)}),a?i=r[0].href.replace(a,"sort="+t):i+="&sort="+t,showFileList(i)}),$(".file-list-item")[0].oncontextmenu=function(e){var t=(target=$(e.target)).closest(".item");if(t.length>0)t.find(".list, .thumb").trigger("click");else{target.closest(".file-list-item").find(".list, .thumb").removeClass("selected"),$(".first-row button,.first-row a").attr("disabled","disabled");var a=$(".btn-file-preview");a.removeAttr("href").attr("title",a.text());var r=$(".btn-file-download");r.removeAttr("href").attr("title",r.text()),$(".btn-roxymce-select").attr("disabled","disabled")}return!1},$.contextMenu({selector:".file-list-item",items:{preview:{name:msg_preview,icon:"fa-search",callback:function(){$(".btn-file-preview").trigger("click")},disabled:function(){return 0===target.closest(".item").length}},download:{name:msg_download,icon:"fa-download",callback:function(){$(".btn-file-download").trigger("click")},disabled:function(){return 0===target.closest(".item").length}},separator:{type:"cm_separator"},cut:{name:msg_cut,icon:"fa-cut",callback:function(){var e=folder_list.treeview("getSelected"),t=$(".btn-file-preview").attr("title");$.ajax({type:"get",cache:!1,dataType:"json",url:url_file_cut+"?folder="+e[0].path+"&file="+t,success:function(e){0===e.error?(file_copy=!1,file_cut=!0):alert(e.message)},error:function(){alert(msg_somethings_went_wrong)}})},disabled:function(){return 0===target.closest(".item").length}},copy:{name:msg_copy,icon:"fa-copy",callback:function(){var e=folder_list.treeview("getSelected"),t=$(".btn-file-preview").attr("title");$.ajax({type:"get",cache:!1,dataType:"json",url:url_file_copy+"?folder="+e[0].path+"&file="+t,success:function(e){0===e.error?(file_cut=!1,file_copy=!0):alert(e.message)},error:function(){alert(msg_somethings_went_wrong)}})},disabled:function(){return 0===target.closest(".item").length}},paste:{name:msg_paste,icon:"fa-clipboard",callback:function(){var e=folder_list.treeview("getSelected");$.ajax({type:"get",cache:!1,dataType:"json",url:url_file_paste+"?folder="+e[0].path,success:function(t){0===t.error?(file_copy=!1,file_cut=!1,showFileList(e[0].href)):alert(t.message)},error:function(){alert(msg_somethings_went_wrong)}})},disabled:function(){return!file_copy&&!file_cut}},rename:{name:msg_rename,icon:"fa-pencil",callback:function(){$(".btn-file-rename").trigger("click")},disabled:function(){return 0===target.closest(".item").length}},remove:{name:msg_delete,icon:"fa-trash",callback:function(){$(".btn-file-remove").trigger("click")},disabled:function(){return 0===target.closest(".item").length}}}});